<html>
<head>
    <title>Descargando...</title>
    <style>
        body{
            background-color: gray;
        }
        #pdf{
            width: 708px;
            padding: 66px 90px;
            background-color: white;
            margin-left: 50%;
            translate: -50% 0;
        }
        .header{
            border-bottom: 4px solid #00B0F0;
            float: left;
            width: 100%;
        }
        .header h1{
            font-size: 23;
            font-family: sans-serif;
            color: #012B55;
            width: 50%;
            float: left;
        }
        .header img{
            width: 140px;
            float: right;
        }
        .section-1{
            float: left;
            width: 100%;
            border-bottom: 4px solid #00B0F0;
            padding: 16px 0;
        }
        .section-1 p{
            color: #012B55;
            font-family: sans-serif;
            font-weight: 600;
            font-size: 14px;
        }
        .section-1 div:nth-child(1){
            width: calc(64% - 16px);
            float: left;
        }
        .section-1 div:nth-child(2){
            width: 36%;
            float: left;
            text-align: right;
        }
        .footer{
            line-height: 6px;
        }
        .footer p{
            color: #012B55;
            font-family: sans-serif;
            font-size: 14px;
        }
        .section-3{
            width: 100%;
            float: left;
        }
        .section-3 h2{
            color: #012B55;
            font-family: sans-serif;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: -5px;
        }
        .section-3 li{
            color: #012B55;
            font-family: sans-serif;
            font-size: 14px;
        }
        .section-3 ul{
            line-height: 19px;
        }
        .section-3 p{
            color: #012B55;
            font-family: sans-serif;
            font-size: 14px;
        }
        .section-2{
            width: 100%;
            float: left;
            border-bottom: 4px solid #00B0F0;
        }
        .section-2 table{
            text-align: center;
            font-size: 15px;
            width: 100%;
            font-family: sans-serif;
            margin-top: 28px;
            border-collapse: collapse;
        }
        .table-orders tr:nth-last-child(-n + 5) {
            border-bottom: none !important;
        }
        .table-orders tr td{
            padding: 28px 0 !important;
        }
        .table-orders tr:nth-last-child(-n + 5) td{
            padding: 4px 12px !important;
            white-space: nowrap;
            text-align: right;
        }
        .section-2 table tr,.section-2 table thead{
            border-bottom:2px solid #BEBEBE;
        }
        .btn-pagar{
            margin-top: 16px;
            float: right;
            text-decoration: none;
            font-family: sans-serif;
            background-color: #00B0F0;
            color: white;
            font-weight: 600;
            padding: 9px 14px;
            border-radius: 32px;
            font-size: 14px;
            letter-spacing: 1px;
            margin-bottom: 28px;
            margin-right: 22px;
            margin-bottom: 28px;
        }
    </style>
</head>
    <body>
        <div id="pdf">
        <div class="header">
            <h1>Cotización <span class="info-orden"></span></h1>
            <img src="logo.webp">
        </div>

        <div class="section-1">
            <div>
                <p style="font-weight: bold !important;">Para Paquetes</p>
                <p class="info-ejecutivo">Ejecutivo</p>
                <p class="info-correo">correo</p>
                <p class="info-telefono">telefono</p>
                <p>&nbsp;</p>
                <p>Para</p>
                <p class="info-cliente">Cliente</p>
            </div>
            <div>
                <p>Fecha: <span class="info-fecha"></span></p>
            </div>
        </div>

        <div class="section-2">
            <table>
                <thead>
                    <th>Cantidad</th>
                    <th>Producto</th>
                    <th>Precio Unitario</th>
                    <th>Subtotal</th>
                </thead>
                <tbody class="table-orders">
                    <!--<tr>
                        <td>10</td>
                        <td>15 x 15 x 10 cm - Cajas de Cartón para Envíos</td>
                        <td>$193.96</td>
                        <td>$1,639.60</td>
                    </tr>
                    <tr>
                        <td>10</td>
                        <td>15 x 15 x 10 cm - Cajas de Cartón para Envíos</td>
                        <td>$193.96</td>
                        <td>$1,639.60</td>
                    </tr>-->
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><strong>Subtotal</strong></td>
                        <td class="info-subtotal">$0.00</td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><strong>Impuestos Totales</strong></td>
                        <td class="info-impuestos">$0.00</td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><strong>Envío</strong></td>
                        <td class="info-envio">$0.00</td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><strong>Descuento</strong></td>
                        <td class="info-descuento">$0.00</td>
                    </tr>
                    <tr>
                        <td>&nbsp;</td>
                        <td>&nbsp;</td>
                        <td><strong style="color: #47B2FA;">TOTAL</strong></td>
                        <td class="info-total">$0.00</td>
                    </tr>
                </tbody>
            </table>
            <a href="https://youtube.com" class="btn-pagar">PAGAR EN LÍNEA</a>
        </div>

        <div class="section-3">
            <h2>Condiciones Comerciales</h2>
            <ul>
                <li><strong>Formas de pago: </strong>tarjeta de crédito, débito o transferencia SPEI.</li>
                <li><strong>Tiempo de entrega: </strong>3 a 5 días hábiles a partir del pago total y stock disponible. </li>
                <li>El precio especial expuesto es válido en la compra del volumen expuesto. </li>
            </ul>
            <p>Confiamos en que, al evaluar la propuesta, considerarán nuestra disponibilidad, la calidad de nuestros productos y el servicio que ofrecemos. Quedamos a sus órdenes para cualquier aclaración o información adicional. </p>
        </div>
            <div class="footer">
                <p><strong>Información de Pago:</strong></p>
                <p>&nbsp;</p>
                <p><strong>Titular de la Cuenta:</strong> Suministros Para Paquetes S.A. DE C.V.</p>
                <p><strong>Banco:</strong> BBVA BANCOMER</p>
                <p><strong>No. de Cuenta:</strong> 0115828635</p>
                <p><strong>No. de CLABE Bancaria:</strong> 012580001158286351</p>
            </div>
        </div>


        <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
        <script
            src="https://code.jquery.com/jquery-3.7.1.min.js"
            integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
            crossorigin="anonymous"></script>
        <script>
$(document).ready(function(){
    function decodeLineItemsFromUrl(encoded) {
        const decoded = atob(decodeURIComponent(encoded));
        return JSON.parse(decoded);
    }

function exportPDFasBase64() {
    const element = document.getElementById("pdf");

    html2pdf()
        .from(element)
        .outputPdf('datauristring')   // returns base64
        .then(base64 => {
            console.log(base64); // "data:application/pdf;base64,JVBERi0xLj..."

            // If you want ONLY the base64 part:
            const pureBase64 = base64.split(',')[1];

            // Send it to your endpoint
            fetch("https://your-endpoint.com/upload", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    pdf_base64: pureBase64
                })
            });
        });
}
function fechapdf() {
    const mesesAbrev = [
        "ene", "feb", "mar", "abr", "may", "jun",
        "jul", "ago", "sep", "oct", "nov", "dic"
    ];

    const hoy = new Date();
    const dia = String(hoy.getDate()).padStart(2, "0");
    const mes = mesesAbrev[hoy.getMonth()];
    const anio = hoy.getFullYear();

    return `${dia}-${mes}-${anio}`;
}

function exportPDF() {
    const element = document.getElementById("pdf");
    
    const opt = {
        margin:       0,
        filename:     'Cotizacion '+$('.info-cliente').text()+' '+fechapdf()+'.pdf',
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },       // High quality
        jsPDF:        { unit: 'pt', format: 'letter', orientation: 'portrait' }
    };

    html2pdf().from(element).set(opt).save();
}

function formatMoneyMXN(amount) {
    return "$" + amount
        .toFixed(2)
        .replace(/\d(?=(\d{3})+\.)/g, "$&,") + " MXN";
}
function getParamsFormatted() {
    const params = new URLSearchParams(window.location.search);

    // Helper: format currency
    const money = num => 
        Number(num.replace("_", "."))
        .toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    // Helper: format phone (Mexico)
    const formatPhone = tel =>
        tel.replace(/(\d{2})(\d{4})(\d{4})/, "$1-$2-$3");

    // Helper: fix email
    const fixEmail = email =>
        email.replace("_", ".").replace("_", "."); // in case there are 2 underscores

    return {
        ejecutivo: params.get("ejecutivo"),
        cliente: params.get('cliente'),
        mail: fixEmail(params.get("mail")),
        telefono: formatPhone(params.get("telefono")),
        orden: "#" + params.get("orden"),
        subtotal: "$" + money(params.get("subtotal")) + " MXN",
        tax: "$" + money(params.get("tax")) + " MXN",
        envio: "$" + money(params.get("envio")) + " MXN",
        descuento: "$" + money(params.get("descuento")) + " MXN",
        total: "$" + money(params.get("total")) + " MXN",
        url:decodeURIComponent(params.get("checkout")),
        items: decodeLineItemsFromUrl(params.get("items"))
    };
}

function fechaActualFormateada() {
    const meses = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
    ];

    const hoy = new Date();
    const dia = hoy.getDate();
    const mes = meses[hoy.getMonth()];
    const anio = hoy.getFullYear();

    return `${dia} de ${mes} de ${anio}`;
}


$('.info-ejecutivo').text(getParamsFormatted().ejecutivo);
$('.info-correo').text(getParamsFormatted().mail);
$('.info-telefono').text(getParamsFormatted().telefono);
$('.info-cliente').text(getParamsFormatted().cliente);
$('.info-orden').text(getParamsFormatted().orden);
$('.info-fecha').text(fechaActualFormateada());
$('.info-subtotal').text(getParamsFormatted().subtotal);
$('.info-impuestos').text(getParamsFormatted().tax);
$('.info-envio').text(getParamsFormatted().envio);
$('.info-descuento').text("-"+getParamsFormatted().descuento);
$('.info-total').text(getParamsFormatted().total);

$('.btn-pagar').attr('href',getParamsFormatted().url.replace('_','.'));

var arr_items=getParamsFormatted().items;
for (var i = arr_items.length - 1; i >= 0; i--) {
    $('.table-orders').prepend('<tr><td>'+arr_items[i].quantity+'</td><td>'+arr_items[i].title+'</td><td>' + formatMoneyMXN(arr_items[i].unitPrice)+'</td><td>'+ formatMoneyMXN(arr_items[i].originalTotal)+'</td></tr>');
}

console.log(getParamsFormatted());

setTimeout(() => {
    exportPDF();
    exportPDFasBase64();
  }, 800);

            });
        </script>
    </body>
</html>